<!doctype html>

<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>G2 Ingegneria ‚Ä¢ Gestione Commesse (Locale)</title>
  <style>
    :root {
      --g2-primary: #1a5a5c;    /* Teal G2 */
      --g2-secondary: #dc2626;  /* Rosso G2 */
      --g2-accent: #f8fafc;     /* Bianco */
      --g2-dark: #0f172a;       /* Sfondo scuro */
      --g2-text: #334155;       /* Testo */
      --g2-success: #16a34a;    /* Azioni positive */
      --g2-warning: #ea580c;    /* Attenzione */
      --radius: 14px;
    }
    html, body { height: 100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; color: var(--g2-text); background: var(--g2-accent); }
    .app { max-width: 1200px; margin: 0 auto; }
    header { display:flex; align-items:center; justify-content:space-between; padding: 1rem 1.25rem; background:#fff; border-bottom: 2px solid var(--g2-primary); position: sticky; top:0; z-index:10; }
    .brand { display:flex; gap:.75rem; align-items:center; }
    .brand-logo { width: 36px; height:36px; border-radius:9px; background: linear-gradient(135deg, var(--g2-primary), #0b8a8d); display:grid; place-items:center; color:#fff; font-weight:700; }
    .brand h1 { font-size: 1.05rem; margin:0; color: var(--g2-primary); letter-spacing:.2px; }
    .ai-status { font-size:.9rem; display:flex; align-items:center; gap:.5rem; color:#555; }
    .ai-status .status-dot { width:10px; height:10px; border-radius:50%; background:#aaa; display:inline-block; }
    .ai-status.active .status-dot { background: var(--g2-success); }
    .ai-status.fallback .status-dot { background:#aaa; }.tab-container { width: 100%; min-height: calc(100vh - 70px); display:flex; flex-direction: column; }
.tab-buttons { display:flex; gap:0; border-bottom:2px solid var(--g2-primary); background: var(--g2-accent); padding:0; }
.tab-button { flex:1; padding: 0.9rem; background:transparent; border:none; border-bottom:3px solid transparent; cursor:pointer; font-size:1rem; font-weight:600; color:var(--g2-text); transition: all .25s ease; }
.tab-button:hover { background: rgba(26, 90, 92, .08); }
.tab-button.active { color: var(--g2-primary); border-bottom-color: var(--g2-secondary); background:#fff; }
.tab-panels { flex:1; padding: 1.25rem; }
.tab-panel { display:none; animation: fadeIn .25s ease; }
.tab-panel.active { display:block; }

.sub-tab-buttons { display:flex; gap:.5rem; margin: .5rem 0 1rem; border-bottom:1px solid #e5e7eb; }
.sub-tab-button { padding:.5rem .9rem; background:transparent; border:none; border-bottom:2px solid transparent; cursor:pointer; transition:.2s; font-weight:600; }
.sub-tab-button.active { color: var(--g2-secondary); border-bottom-color: var(--g2-secondary); }

.card { background:#fff; border:1px solid #e5e7eb; border-radius: var(--radius); padding: 1rem; box-shadow: 0 6px 18px rgba(15, 23, 42, .06); }
.grid { display:grid; gap:1rem; }
.grid.cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
.grid.cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }

.row { display:grid; grid-template-columns: 180px 1fr; align-items:center; gap:.75rem; margin:.55rem 0; }
label { font-weight:600; font-size:.95rem; }
input[type="text"], input[type="number"], select, textarea { width:100%; padding:.6rem .7rem; border:1px solid #cbd5e1; border-radius:10px; background:#fff; color:#0f172a; font-size:.95rem; }
input[readonly] { background:#f1f5f9; color:#475569; }
textarea { min-height: 90px; }

.btns { display:flex; gap:.5rem; flex-wrap:wrap; }
.btn { border:1px solid transparent; background: var(--g2-primary); color:#fff; padding:.65rem .9rem; border-radius: 12px; font-weight:700; cursor:pointer; transition:.2s; }
.btn.secondary { background:#fff; color: var(--g2-primary); border-color: var(--g2-primary); }
.btn.warn { background: var(--g2-warning); }
.btn.danger { background: var(--g2-secondary); }
.btn.success { background: var(--g2-success); }
.btn:disabled { opacity:.5; cursor:not-allowed; }

table { width:100%; border-collapse:collapse; }
th, td { padding:.6rem .5rem; border-bottom:1px solid #e5e7eb; text-align:left; font-size:.94rem; }
th { background:#f8fafc; position:sticky; top:0; z-index:1; }
tbody tr:hover { background:#f6f7f9; }

.kbd { background:#f1f5f9; border:1px solid #cbd5e1; padding:.1rem .35rem; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.85rem; }
.muted { color:#64748b; font-size:.92rem; }
.tag { font-size:.8rem; padding:.15rem .4rem; border-radius:999px; background:#e2e8f0; color:#0f172a; }

@keyframes fadeIn { from { opacity:0; transform: translateY(8px);} to { opacity:1; transform: none; } }
.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}
.mb-1{margin-bottom:.25rem}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}

  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="brand-logo">G2</div>
        <h1>Gestione Commesse ‚Ä¢ Locale</h1>
      </div>
      <div id="ai-status" class="ai-status">
        <span class="status-dot"></span>
        Routing Basato su Regole + Learning
      </div>
    </header><div class="tab-container">
  <div class="tab-buttons" role="tablist">
    <button class="tab-button active" data-tab="home" role="tab" aria-selected="true">üè† Home</button>
    <button class="tab-button" data-tab="new" role="tab" aria-selected="false">‚ûï Nuova Commessa</button>
    <button class="tab-button" data-tab="manage" role="tab" aria-selected="false">üìÅ Gestione</button>
    <button class="tab-button" data-tab="routing" role="tab" aria-selected="false">ü§ñ Auto‚ÄëRouting</button>
    <button class="tab-button" data-tab="system" role="tab" aria-selected="false">‚öôÔ∏è Sistema</button>
  </div>

  <div class="tab-panels">
    <!-- HOME -->
    <section class="tab-panel active" id="home-panel" data-panel="home" role="tabpanel">
      <div class="grid cols-3">
        <div class="card">
          <h3>Stato archivio</h3>
          <div class="grid cols-2 mt-2">
            <div><div class="muted">Commesse</div><div id="kpi-projects" style="font-size:1.6rem; font-weight:800">0</div></div>
            <div><div class="muted">Clienti</div><div id="kpi-clients" style="font-size:1.6rem; font-weight:800">0</div></div>
          </div>
          <div class="mt-3 muted">Dati memorizzati in IndexedDB. Metadati in localStorage.</div>
        </div>
        <div class="card">
          <h3>Azioni rapide</h3>
          <div class="btns mt-2">
            <button class="btn" id="go-new">Nuova commessa</button>
            <button class="btn secondary" id="export-json">Esporta DB (.json)</button>
            <button class="btn secondary" id="import-json">Importa DB (.json)</button>
          </div>
          <input type="file" id="import-file" accept="application/json" hidden>
        </div>
        <div class="card">
          <h3>Note su File System Access API</h3>
          <div class="muted mt-2">Chrome/Edge 86+; richiede <span class="kbd">localhost</span> o HTTPS. Su Firefox/Safari sono attivi i fallback con script di creazione cartelle.</div>
        </div>
      </div>
    </section>

    <!-- NUOVA COMMESSA -->
    <section class="tab-panel" id="new-panel" data-panel="new" role="tabpanel" hidden>
      <div class="card">
        <h3>Crea nuova commessa</h3>
        <div class="row"><label>Cliente</label><input id="inp-client" type="text" placeholder="Es. G2 Ingegneria" /></div>
        <div class="row"><label>Citt√†</label><input id="inp-city" type="text" placeholder="Es. Milano" /></div>
        <div class="row"><label>Oggetto</label><input id="inp-object" type="text" placeholder="Descrizione sintetica" /></div>
        <div class="row"><label>Anno (AA)</label><input id="inp-year" type="number" min="0" max="99" /></div>
        <div class="row"><label>Template</label>
          <select id="inp-template">
            <option value="LUNGO">LUNGO ‚Äì progetti complessi</option>
            <option value="BREVE">BREVE ‚Äì progetti semplici</option>
          </select>
        </div>
        <div class="row"><label>Codice commessa</label><input id="inp-code" type="text" readonly></div>
        <div class="btns mt-2">
          <button class="btn" id="btn-generate-code">Genera codice</button>
          <button class="btn success" id="btn-save-project" disabled>Salva commessa</button>
          <button class="btn secondary" id="btn-pick-root">Seleziona cartella radice</button>
          <span id="picked-root" class="muted"></span>
        </div>
      </div>

      <div class="card mt-3">
        <h3>Creazione struttura cartelle</h3>
        <div class="btns mt-2">
          <button class="btn" id="btn-create-structure" disabled>Crea struttura nella cartella selezionata</button>
          <button class="btn secondary" id="btn-download-scripts" disabled>Scarica script fallback (.bat/.sh)</button>
        </div>
        <div class="muted mt-2">La cartella verr√† creata come <span class="kbd">[CODICE]_[OGGETTO]</span>.</div>
      </div>
    </section>

    <!-- GESTIONE -->
    <section class="tab-panel" id="manage-panel" data-panel="manage" role="tabpanel" hidden>
      <div class="sub-tab-container">
        <div class="sub-tab-buttons">
          <button class="sub-tab-button active" data-subtab="projects">Commesse</button>
          <button class="sub-tab-button" data-subtab="clients">Clienti</button>
        </div>
        <div class="sub-tab-panels">
          <div class="sub-tab-panel active" data-subpanel="projects">
            <div class="card">
              <div class="btns mb-2">
                <button class="btn secondary" id="refresh-projects">Aggiorna elenco</button>
              </div>
              <div style="max-height: 55vh; overflow:auto;" class="mt-1">
                <table>
                  <thead><tr><th>Codice</th><th>Cliente</th><th>Citt√†</th><th>Oggetto</th><th>Anno</th><th>Template</th><th>Azioni</th></tr></thead>
                  <tbody id="tbl-projects"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="sub-tab-panel" data-subpanel="clients" hidden>
            <div class="card">
              <div style="max-height: 55vh; overflow:auto;">
                <table>
                  <thead><tr><th>Sigla</th><th>Cliente</th><th>N. commesse</th></tr></thead>
                  <tbody id="tbl-clients"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ROUTING -->
    <section class="tab-panel" id="routing-panel" data-panel="routing" role="tabpanel" hidden>
      <div class="card">
        <h3>Auto‚Äërouting file</h3>
        <div class="row"><label>Template progetto</label>
          <select id="routing-template">
            <option value="LUNGO">LUNGO</option>
            <option value="BREVE">BREVE</option>
          </select>
        </div>
        <div class="row"><label>Carica file</label><input id="routing-file" type="file" /></div>
        <div class="btns mt-2">
          <button class="btn" id="btn-route-file">Suggerisci percorso</button>
        </div>
        <div id="routing-result" class="mt-3"></div>
      </div>
    </section>

    <!-- SISTEMA -->
    <section class="tab-panel" id="system-panel" data-panel="system" role="tabpanel" hidden>
      <div class="sub-tab-container">
        <div class="sub-tab-buttons">
          <button class="sub-tab-button active" data-subtab="storage">Storage</button>
          <button class="sub-tab-button" data-subtab="ai">AI</button>
        </div>
        <div class="sub-tab-panels">
          <div class="sub-tab-panel active" data-subpanel="storage">
            <div class="card">
              <h3>Gestione storage locale</h3>
              <div class="btns mt-2">
                <button class="btn danger" id="wipe-db">Svuota IndexedDB</button>
                <button class="btn warn" id="wipe-ls">Svuota localStorage</button>
              </div>
            </div>
          </div>
          <div class="sub-tab-panel" data-subpanel="ai" hidden>
            <div class="card">
              <h3>Integrazione AI (opzionale)</h3>
              <div class="row"><label>Claude API key</label><input id="inp-api" type="text" placeholder="sk-..." /></div>
              <div class="btns mt-2">
                <button class="btn" id="btn-save-api">Attiva</button>
                <button class="btn secondary" id="btn-clear-api">Disattiva</button>
              </div>
              <div class="muted mt-2">Richiede HTTPS o proxy locale su <span class="kbd">http://localhost:3001</span>. La chiave √® salvata in localStorage in base64.</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

  </div>  <script>
  /*********************** UTILS ************************/ 
  class InputValidator {
    sanitizeFileName(name) {
      return name.replace(/[<>:"/\\|?*\x00-\x1F]/g, '_').substring(0, 255);
    }
    validateProjectCode(code) {
      const pattern = /^[0-9]{2}[A-Z0-9]{3}[A-Z0-9]{3}[0-9]{2}$/;
      if (!pattern.test(code)) throw new Error('Formato codice non valido');
      return code;
    }
    escapeHTML(str) { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; }
    generateSafeAcronym(text) {
      return (text||'').toUpperCase().replace(/[^A-Z0-9]/g,'').substring(0,3).padEnd(3,'X');
    }
  }

  /*********************** STORAGE ************************/ 
  class StorageManager {
    async init() { this.db = await this.openIndexedDB(); this.cache = window.localStorage; }
    openIndexedDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open('G2CommesseDB', 1);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('projects')) db.createObjectStore('projects', { keyPath: 'id' });
          if (!db.objectStoreNames.contains('files')) db.createObjectStore('files', { keyPath: 'id' });
          if (!db.objectStoreNames.contains('logs')) db.createObjectStore('logs', { keyPath: 'timestamp' });
        };
      });
    }
    async saveProject(project) {
      const metadata = { id: project.id, code: project.code, client: project.client, city: project.city, year: project.year, template: project.template };
      this.cache.setItem(`meta_${project.id}`, JSON.stringify(metadata));
      const tx = this.db.transaction(['projects'], 'readwrite');
      await tx.objectStore('projects').put(project);
      await tx.complete; // compatible shim; ignored by most browsers
    }
    async getAllProjects() { return new Promise((resolve, reject) => {
      const tx = this.db.transaction(['projects'], 'readonly');
      const store = tx.objectStore('projects');
      const items = []; const req = store.openCursor();
      req.onsuccess = (e) => { const cur = e.target.result; if (cur) { items.push(cur.value); cur.continue(); } else resolve(items); };
      req.onerror = () => reject(req.error);
    }); }
  }

  /*********************** FILESYSTEM ************************/ 
  async function createFolderStructure(rootHandle, structure) {
    for (const [name, content] of Object.entries(structure)) {
      try {
        const folderHandle = await rootHandle.getDirectoryHandle(name, { create: true });
        if (typeof content === 'object') { await createFolderStructure(folderHandle, content); }
      } catch (e) { console.error('Errore creazione', name, e); }
    }
  }

  function getTemplateStructure(template, displayName) {
    const base = {}; base[displayName] = {};
    if (template === 'LUNGO') {
      base[displayName] = {
        '1_CONSEGNA': {},
        '2_PERMIT': {},
        '3_PROGETTO': { 'ARC':{}, 'CME':{}, 'CRONO_CAPITOLATI_MANUT':{}, 'IE':{}, 'IM':{}, 'IS':{}, 'REL':{}, 'SIC':{}, 'STR':{}, 'X_RIF':{} },
        '4_MATERIALE_RICEVUTO': {},
        '5_CANTIERE': { '0_PSC_FE':{}, 'IMPRESA': { 'CONTRATTO':{}, 'CONTROLLI':{}, 'DOCUMENTI':{} } },
        '6_VERBALI_NOTIFICHE_COMUNICAZIONI': { 'COMUNICAZIONI':{}, 'NP':{}, 'ODS':{}, 'VERBALI':{} },
        '7_SOPRALLUOGHI': {},
        '8_VARIANTI': {},
        '9_PARCELLA': {},
        '10_INCARICO': {}
      };
    } else {
      base[displayName] = { 'CONSEGNA': {}, 'ELABORAZIONI': {}, 'MATERIALE_RICEVUTO': {}, 'SOPRALLUOGHI': {} };
    }
    return base;
  }

  function buildScriptCommands(structure, prefix = '') {
    const cmds = { win: [], sh: [] };
    function walk(obj, path) {
      for (const [name, content] of Object.entries(obj)) {
        const p = path ? `${path}/${name}` : name;
        cmds.win.push(`mkdir "${p.replaceAll('/', '\\')}"`);
        cmds.sh.push(`mkdir -p "${p}"`);
        if (typeof content === 'object') walk(content, p);
      }
    }
    walk(structure, prefix);
    return cmds;
  }

  function download(filename, text) {
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  /*********************** ROUTER ************************/ 
  class SmartFileRouter {
    constructor() {
      this.methods = { ai: false, rules: true, learning: true };
      this.learnedPatterns = JSON.parse(localStorage.getItem('learned_patterns')||'{}');
      this.validator = new InputValidator();
    }
    async init() { await this.checkAIAvailability(); this.updateUIStatus(); }
    async checkAIAvailability() {
      try { const r = await fetch('http://localhost:3001/health'); if (r.ok) { this.methods.ai = true; this.useProxy = true; return; } } catch {}
      const savedKey = localStorage.getItem('claude_key_enc');
      if (savedKey) { this.apiKey = atob(savedKey); this.methods.ai = await this.testApiKey(this.apiKey); }
    }
    async configureAI(apiKey) {
      if (!apiKey) { localStorage.removeItem('claude_key_enc'); this.methods.ai=false; this.apiKey=null; this.updateUIStatus(); return {success:true, message:'Configurazione AI rimossa'}; }
      const ok = await this.testApiKey(apiKey);
      if (ok) { localStorage.setItem('claude_key_enc', btoa(apiKey)); this.apiKey = apiKey; this.methods.ai = true; this.updateUIStatus(); return {success:true, message:'API key configurata'}; }
      return {success:false, message:'API key non valida'};
    }
    async testApiKey(key) {
      try {
        const r = await fetch('https://api.anthropic.com/v1/messages', { method:'POST', headers:{'x-api-key':key,'anthropic-version':'2023-06-01','content-type':'application/json'}, body: JSON.stringify({ model:'claude-3-haiku-20240307', max_tokens: 10, messages:[{role:'user', content:'test'}] }) });
        return r.ok;
      } catch { return false; }
    }
    async routeFile(file, projectTemplate) {
      let result = this.checkLearnedPatterns(file); if (result.confidence>0.9) { result.method='learned'; return result; }
      if (this.methods.ai) { try { result = await this.aiRouting(file); if (result.confidence>0.8) { result.method='ai'; return result; } } catch { /* fallback */ } }
      result = this.rulesBasedRouting(file, projectTemplate); result.method = 'rules'; if (result.confidence<0.7) result.needsConfirmation = true; return result;
    }
    rulesBasedRouting(file, template) {
      const name = file.name.toLowerCase(); const ext = name.split('.').pop();
      const rulesLungo = {
        'dwg|dxf': { patterns:[ {keywords:['planimetria','pianta','prospetto','sezione'], folder:'3_PROGETTO/ARC/'}, {keywords:['struttura','armatura','trave','pilastro'], folder:'3_PROGETTO/STR/'}, {keywords:['impianto','elettrico','idraulico'], folder:'3_PROGETTO/IM/'} ], default:'3_PROGETTO/X_RIF/' },
        'pdf|doc|docx': { patterns:[ {keywords:['relazione','tecnica'], folder:'3_PROGETTO/REL/'}, {keywords:['verbale','riunione'], folder:'6_VERBALI_NOTIFICHE_COMUNICAZIONI/VERBALI/'}, {keywords:['contratto','accordo'], folder:'5_CANTIERE/IMPRESA/CONTRATTO/'}, {keywords:['parcella','fattura'], folder:'9_PARCELLA/'}, {keywords:['incarico','nomina'], folder:'10_INCARICO/'} ], default:'4_MATERIALE_RICEVUTO/' },
        'jpg|jpeg|png|tiff': { patterns:[ {keywords:['sopralluogo','foto','cantiere'], folder:'7_SOPRALLUOGHI/'} ], default:'7_SOPRALLUOGHI/' },
        'xls|xlsx': { patterns:[ {keywords:['computo','metrico','cme'], folder:'3_PROGETTO/CME/'}, {keywords:['parcella','fattura'], folder:'9_PARCELLA/'} ], default:'3_PROGETTO/CME/' }
      };
      const rulesBreve = {
        'pdf|doc|docx|dwg|dxf': { patterns:[ {keywords:['relazione','calcolo','progetto'], folder:'ELABORAZIONI/'} ], default:'ELABORAZIONI/' },
        'jpg|jpeg|png|tiff': { patterns:[], default:'SOPRALLUOGHI/' }
      };
      const rules = template==='LUNGO' ? rulesLungo : rulesBreve;
      for (const [extPattern, config] of Object.entries(rules)) {
        if (new RegExp(extPattern).test(ext)) {
          for (const pattern of config.patterns) {
            const matches = pattern.keywords.some(k => name.includes(k));
            if (matches) return { suggested_path: pattern.folder, confidence: 0.8, reasoning: `File ${ext} con keyword corrispondente`, alternatives: [config.default] };
          }
          return { suggested_path: config.default, confidence: 0.6, reasoning: `Default per tipo ${ext}`, alternatives: [] };
        }
      }
      return { suggested_path: template==='LUNGO' ? '4_MATERIALE_RICEVUTO/' : 'MATERIALE_RICEVUTO/', confidence: 0.5, reasoning: 'Fallback', alternatives: [] };
    }
    async aiRouting(file) {
      if (!this.methods.ai) throw new Error('AI non configurato');
      const metadata = { name: file.name, type: file.type, size: file.size, extension: file.name.split('.').pop() };
      if (file.type.startsWith('text/') && file.size < 10000) { metadata.preview = await this.getTextPreview(file); }
      if (this.useProxy) {
        const r = await fetch('http://localhost:3001/analyze', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(metadata) });
        return await r.json();
      } else if (this.apiKey) { return this.callClaudeDirectly(metadata); }
    }
    async callClaudeDirectly(metadata) {
      const prompt = `Analizza questo file per un progetto di ingegneria civile.\nNome: ${metadata.name}\nTipo: ${metadata.type}\nEstensione: ${metadata.extension}\nRispondi SOLO JSON {"suggested_path":"...","confidence":0-1,"reasoning":"..."}`;
      const r = await fetch('https://api.anthropic.com/v1/messages', { method:'POST', headers:{'x-api-key':this.apiKey,'anthropic-version':'2023-06-01','content-type':'application/json'}, body: JSON.stringify({ model:'claude-3-haiku-20240307', max_tokens: 200, messages:[{role:'user', content: prompt}] })});
      const data = await r.json();
      return JSON.parse(data.content[0].text);
    }
    checkLearnedPatterns(file) { const pattern = this.extractPattern(file); if (this.learnedPatterns[pattern]) { return { suggested_path: this.learnedPatterns[pattern], confidence: .95, reasoning:'Pattern appreso' }; } return { confidence: 0 } }
    learnFromCorrection(file, actualPath) { const p = this.extractPattern(file); this.learnedPatterns[p] = actualPath; localStorage.setItem('learned_patterns', JSON.stringify(this.learnedPatterns)); }
    extractPattern(file) { const ext = file.name.split('.').pop().toLowerCase(); const keywords = file.name.toLowerCase().replace(/[^a-z0-9]/g,' ').split(' ').filter(w=>w.length>3).slice(0,3); return `${ext}:${keywords.join(',')}`; }
    getTextPreview(file, maxChars=1000) { return new Promise(res=>{ const r = new FileReader(); r.onload = e=>res(e.target.result.substring(0,maxChars)); r.readAsText(file.slice(0,maxChars)); }); }
    updateUIStatus() { const s = document.getElementById('ai-status'); if (!s) return; if (this.methods.ai) { s.innerHTML = '<span class="status-dot"></span> AI Routing Attivo (Claude)'; s.className='ai-status active'; } else { s.innerHTML = '<span class="status-dot"></span> Routing Basato su Regole + Learning'; s.className='ai-status fallback'; } }
  }

  /*********************** TABS ************************/ 
  class TabManager { constructor(){ this.currentTab='home'; this.init(); }
    init(){ const tabContainer=document.querySelector('.tab-buttons'); if(!tabContainer) return; tabContainer.addEventListener('click', (e)=>{ const b=e.target.closest('.tab-button'); if(!b) return; e.preventDefault(); this.switchTab(b.dataset.tab); }); this.switchTab('home'); this.initSubTabs(); }
    switchTab(tabName){ document.querySelectorAll('.tab-button').forEach(btn=>{ btn.classList.remove('active'); btn.setAttribute('aria-selected','false'); }); document.querySelectorAll('.tab-panel').forEach(p=>{ p.classList.remove('active'); p.setAttribute('hidden',''); }); const ab=document.querySelector(`[data-tab="${tabName}"]`); if(ab){ ab.classList.add('active'); ab.setAttribute('aria-selected','true'); } const ap=document.querySelector(`[data-panel="${tabName}"]`); if(ap){ ap.classList.add('active'); ap.removeAttribute('hidden'); } this.currentTab=tabName; window.dispatchEvent(new CustomEvent('tabChanged',{detail:{tab:tabName}})); }
    initSubTabs(){ document.querySelectorAll('.sub-tab-buttons').forEach(container=>{ container.addEventListener('click',(e)=>{ const b=e.target.closest('.sub-tab-button'); if(!b) return; const panel=container.closest('.sub-tab-container'); this.switchSubTab(panel, b.dataset.subtab); }); }); }
    switchSubTab(container, name){ container.querySelectorAll('.sub-tab-button').forEach(btn=>{ btn.classList.toggle('active', btn.dataset.subtab===name); }); container.querySelectorAll('.sub-tab-panel').forEach(p=>{ const act = p.dataset.subpanel===name; p.classList.toggle('active', act); p.toggleAttribute('hidden', !act); }); }
  }

  /*********************** APP LOGIC ************************/ 
  const validator = new InputValidator();
  const storageManager = new StorageManager();
  const router = new SmartFileRouter();
  let pickedRootHandle = null;
  let pendingProject = null;

  function twoDigits(y){ return String(y).padStart(2,'0'); }
  function computeProjectCode(year2, client, city, allProjects){
    const CLI = validator.generateSafeAcronym(client);
    const CIT = validator.generateSafeAcronym(city);
    const prefix = `${twoDigits(year2)}${CLI}${CIT}`;
    const same = allProjects.filter(p => p.code.startsWith(prefix)).map(p=>parseInt(p.code.slice(-2),10)).sort((a,b)=>a-b);
    let next=1; while (same.includes(next)) next++;
    const code = `${prefix}${twoDigits(next)}`;
    validator.validateProjectCode(code); return code;
  }

  function renderProjectsTable(items){ const tbody=document.getElementById('tbl-projects'); tbody.innerHTML=''; items.sort((a,b)=>a.code.localeCompare(b.code)); for(const p of items){ const tr=document.createElement('tr'); tr.innerHTML = `<td><span class="kbd">${p.code}</span></td><td>${validator.escapeHTML(p.client)}</td><td>${validator.escapeHTML(p.city)}</td><td>${validator.escapeHTML(p.object)}</td><td>${twoDigits(p.year)}</td><td><span class="tag">${p.template}</span></td><td class="btns"><button class="btn secondary" data-act="script" data-id="${p.id}">Script</button><button class="btn" data-act="export" data-id="${p.id}">Export</button></td>`; tbody.appendChild(tr); }
    tbody.addEventListener('click', async (e)=>{ const btn=e.target.closest('button'); if(!btn) return; const id=btn.getAttribute('data-id'); const act=btn.getAttribute('data-act'); const proj = items.find(x=>x.id===id); if(!proj) return; if(act==='export'){ download(`${proj.code}.json`, JSON.stringify(proj, null, 2)); } if(act==='script'){ const displayName = `${proj.code}_${validator.sanitizeFileName(proj.object)}`; const structure = getTemplateStructure(proj.template, displayName); const cmds = buildScriptCommands(structure); download(`${proj.code}_create_dirs.bat`, cmds.win.join('\r\n')); download(`${proj.code}_create_dirs.sh`, cmds.sh.join('\n')); }
    }, {once:true});
  }

  function renderClientsTable(items){ const map=new Map(); for(const p of items){ const key = validator.generateSafeAcronym(p.client); const v = map.get(key)||{sigla:key, name:p.client, n:0}; v.n++; map.set(key,v); } const tbody=document.getElementById('tbl-clients'); tbody.innerHTML=''; Array.from(map.values()).sort((a,b)=>a.sigla.localeCompare(b.sigla)).forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td><span class="kbd">${c.sigla}</span></td><td>${validator.escapeHTML(c.name)}</td><td>${c.n}</td>`; tbody.appendChild(tr); }); }

  function refreshKPIs(items){ document.getElementById('kpi-projects').textContent = items.length; const clients = new Set(items.map(p=>validator.generateSafeAcronym(p.client))); document.getElementById('kpi-clients').textContent = clients.size; }

  /*********************** EVENT BINDINGS ************************/ 
  document.addEventListener('DOMContentLoaded', async () => {
    await storageManager.init(); await router.init();

    const year = new Date().getFullYear()%100; document.getElementById('inp-year').value = twoDigits(year);

    document.getElementById('go-new').onclick = () => tabManager.switchTab('new');

    document.getElementById('btn-generate-code').onclick = async ()=>{
      const client = document.getElementById('inp-client').value.trim();
      const city = document.getElementById('inp-city').value.trim();
      const obj = document.getElementById('inp-object').value.trim();
      const year = parseInt(document.getElementById('inp-year').value||'0',10);
      if(!client||!city||!obj||Number.isNaN(year)) { alert('Compilare Cliente, Citt√†, Oggetto e Anno'); return; }
      const all = await storageManager.getAllProjects();
      try { const code = computeProjectCode(year, client, city, all); document.getElementById('inp-code').value = code; document.getElementById('btn-save-project').disabled=false; } catch(e){ alert(e.message); }
    };

    document.getElementById('btn-save-project').onclick = async ()=>{
      const code = document.getElementById('inp-code').value.trim();
      const client = document.getElementById('inp-client').value.trim();
      const city = document.getElementById('inp-city').value.trim();
      const obj = document.getElementById('inp-object').value.trim();
      const year = parseInt(document.getElementById('inp-year').value||'0',10);
      const template = document.getElementById('inp-template').value;
      if(!code) { alert('Generare prima il codice'); return; }
      const project = { id: crypto.randomUUID(), code, client, city, object: obj, year, template, createdAt: Date.now(), fsRoot: null };
      await storageManager.saveProject(project); pendingProject = project; alert('Commessa salvata in IndexedDB');
      document.getElementById('btn-download-scripts').disabled=false; document.getElementById('btn-create-structure').disabled = !pickedRootHandle; 
    };

    document.getElementById('btn-pick-root').onclick = async ()=>{
      if (!window.showDirectoryPicker) { alert('File System Access API non disponibile in questo browser. Usare gli script fallback.'); return; }
      try { pickedRootHandle = await showDirectoryPicker({ mode:'readwrite' }); document.getElementById('picked-root').textContent = 'Radice selezionata'; document.getElementById('btn-create-structure').disabled = !(pendingProject && pickedRootHandle); } catch {}
    };

    document.getElementById('btn-create-structure').onclick = async ()=>{
      if(!pendingProject || !pickedRootHandle) { alert('Selezionare commessa salvata e cartella radice'); return; }
      const displayName = `${pendingProject.code}_${validator.sanitizeFileName(pendingProject.object)}`;
      const structure = getTemplateStructure(pendingProject.template, displayName);
      await createFolderStructure(pickedRootHandle, structure);
      alert('Struttura creata.');
    };

    document.getElementById('btn-download-scripts').onclick = ()=>{
      if(!pendingProject){ alert('Salvare prima la commessa'); return; }
      const displayName = `${pendingProject.code}_${validator.sanitizeFileName(pendingProject.object)}`;
      const structure = getTemplateStructure(pendingProject.template, displayName);
      const cmds = buildScriptCommands(structure);
      download(`${pendingProject.code}_create_dirs.bat`, cmds.win.join('\r\n'));
      download(`${pendingProject.code}_create_dirs.sh`, cmds.sh.join('\n'));
    };

    document.getElementById('refresh-projects').onclick = async ()=>{ const items = await storageManager.getAllProjects(); renderProjectsTable(items); renderClientsTable(items); refreshKPIs(items); };
    document.getElementById('refresh-projects').click();

    // Export/Import DB
    document.getElementById('export-json').onclick = async ()=>{ const items = await storageManager.getAllProjects(); download('G2Commesse_export.json', JSON.stringify(items,null,2)); };
    document.getElementById('import-json').onclick = ()=> document.getElementById('import-file').click();
    document.getElementById('import-file').onchange = async (e)=>{ const f=e.target.files[0]; if(!f) return; const txt = await f.text(); try{ const arr = JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('Formato non valido'); for(const p of arr){ if(!p.id) p.id=crypto.randomUUID(); await storageManager.saveProject(p); } alert('Import completato'); document.getElementById('refresh-projects').click(); } catch(err){ alert('Errore import: '+err.message); } };

    // Wipe
    document.getElementById('wipe-db').onclick = async ()=>{ const ok=confirm('Confermi eliminazione di tutte le commesse?'); if(!ok) return; const name='G2CommesseDB'; const req = indexedDB.deleteDatabase(name); req.onsuccess=()=>alert('IndexedDB svuotato'); req.onerror=()=>alert('Errore nel wipe DB'); };
    document.getElementById('wipe-ls').onclick = ()=>{ const ok=confirm('Confermi eliminazione dei metadati in localStorage?'); if(!ok) return; Object.keys(localStorage).filter(k=>k.startsWith('meta_')||k==='claude_key_enc'||k==='learned_patterns').forEach(k=>localStorage.removeItem(k)); alert('localStorage svuotato'); };

    // Routing
    document.getElementById('btn-route-file').onclick = async ()=>{
      const inp = document.getElementById('routing-file'); const f=inp.files&&inp.files[0]; if(!f) { alert('Selezionare un file'); return; }
      const template = document.getElementById('routing-template').value;
      const res = await router.routeFile(f, template);
      const box = document.getElementById('routing-result');
      const html = `<div class="card"><div><strong>Cartella suggerita:</strong> <span class="kbd">${validator.escapeHTML(res.suggested_path)}</span></div><div class="mt-1"><strong>Confidenza:</strong> ${Math.round((res.confidence||0)*100)}%</div><div class="mt-1 muted">${validator.escapeHTML(res.reasoning||'')}</div>${res.needsConfirmation?'<div class="mt-2"><span class="tag">Conferma richiesta</span></div>':''}<div class="btns mt-2"><button class="btn success" id="confirm-routing">Conferma</button><button class="btn secondary" id="change-routing">Cambia‚Ä¶</button></div></div>`;
      box.innerHTML = html;
      document.getElementById('confirm-routing').onclick = ()=>{ router.learnFromCorrection(f, res.suggested_path); alert('Apprendimento aggiornato per pattern simili'); };
      document.getElementById('change-routing').onclick = ()=>{ const nv = prompt('Inserisci percorso alternativo (es. 3_PROGETTO/REL/)',''); if(nv){ router.learnFromCorrection(f, nv.replace(/^[\\/]+|[\\/]+$/g,'' ) + '/'); alert('Percorso salvato e appreso'); } };
    };

    // AI config
    document.getElementById('btn-save-api').onclick = async ()=>{ const key=document.getElementById('inp-api').value.trim(); const out=await router.configureAI(key); alert(out.message); };
    document.getElementById('btn-clear-api').onclick = async ()=>{ const out=await router.configureAI(null); alert(out.message); };
  });

  // Init tabs last to ensure element availability
  const tabManager = new TabManager();
  </script></body>
</html>